# 硬件加速H.264解码器

## 项目概述

这是一个使用Swift语言开发的基于VideoToolbox框架的H.264视频硬件解码器示例。该项目展示了如何在macOS/iOS平台上使用系统提供的硬件加速能力进行H.264视频的解码，并将解码后的视频帧保存为PNG图像。

## 功能特点

- 支持硬件加速H.264视频解码
- 自动提取视频流中的SPS和PPS参数集
- 解析和处理H.264 NAL单元
- 支持解码I帧和P帧
- 将解码后的视频帧保存为PNG图像
- 自动回退到软解码（当硬解码不可用时）
- 详细的日志输出，方便调试和学习

## 系统要求

- macOS 10.14+或iOS 12.0+
- Xcode 12.0+
- Swift 5.0+

## 使用方法

1. 将H.264编码的视频文件命名为`video.h264`并放置在`~/Desktop/forshare/HardwareDecoder/HardwareDecoder/`目录下
2. 编译并运行程序
3. 解码后的视频帧将保存在桌面的`decoded_frames`文件夹中

## 核心功能实现

- **格式描述创建**：使用SPS和PPS参数集创建视频格式描述
- **解码会话初始化**：配置并创建VideoToolbox解码会话
- **NAL单元解析**：从H.264比特流中提取NAL单元
- **帧解码处理**：将NAL单元送入解码器并处理回调
- **图像导出**：将解码后的CVPixelBuffer转换为PNG图像

## 实现原理

程序首先解析H.264文件，提取所有NAL单元。然后识别其中的SPS和PPS数据，用于初始化解码器。之后按顺序将视频帧NAL单元送入硬件解码器，VideoToolbox框架会调用回调函数返回解码后的视频帧，程序将这些帧转换为PNG图像保存到磁盘。

## 程序流程

下面是程序执行流程的图示：

```mermaid
flowchart TD
    A[开始] --> B[检查硬件解码支持]
    B --> C{支持硬件解码?}
    C -->|是| D[使用硬件解码]
    C -->|否| E[使用软件解码]
    D --> F[尝试读取H.264文件]
    E --> F
    F --> G{文件存在?}
    G -->|否| H[错误处理]
    G -->|是| I[解析NAL单元]
    I --> J[提取SPS和PPS]
    J --> K[创建视频格式描述]
    K --> L[创建解码会话]
    L --> M[开始解码视频帧]
    M --> N[遍历NAL单元]
    N --> O[解码NAL单元]
    O --> P[保存解码帧]
    P --> Q{更多NAL单元?}
    Q -->|是| N
    Q -->|否| R[等待所有帧完成处理]
    R --> S[清理资源]
    S --> T[结束]
    H --> T
```

## 注意事项

- 程序默认处理1920x1080分辨率的视频，如需其他分辨率，请修改`kWidth`和`kHeight`常量
- 确保H.264视频文件是有效的，且包含必要的SPS和PPS数据
- 当处理大型视频文件时，可能需要增加内存限制
- 解码过程在异步线程中进行，请确保主线程不会提前退出
- 解码后的帧会保存在桌面的`decoded_frames`文件夹，确保该目录有写入权限
